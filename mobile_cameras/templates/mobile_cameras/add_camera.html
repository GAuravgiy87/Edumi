{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="form-container">
    <div class="form-card-large">
        <h2>ðŸ“± Add Mobile Camera</h2>
        <p class="subtitle">Connect your phone camera using IP Webcam or DroidCam</p>
        
        {% if error %}
        <div class="alert alert-error">
            {{ error }}
        </div>
        {% endif %}
        
        <form method="POST">
            {% csrf_token %}
            
            <!-- URL Input Option -->
            <div class="form-group">
                <label for="camera_url">Camera URL (Quick Setup)</label>
                <input type="text" id="camera_url" name="camera_url" placeholder="e.g., http://192.168.1.100:8080/video or http://user:pass@192.168.1.100:4747/mjpegfeed">
                <small>Paste the full camera URL for automatic configuration, or fill in details below manually</small>
            </div>
            
            <div class="divider">
                <span>OR</span>
            </div>
            
            <div class="form-group">
                <label for="name">Camera Name *</label>
                <input type="text" id="name" name="name" placeholder="e.g., My Phone Camera">
            </div>
            
            <div class="form-group">
                <label for="camera_type">Camera Type *</label>
                <select id="camera_type" name="camera_type" onchange="updateDefaults()">
                    <option value="ip_webcam">IP Webcam (Android)</option>
                    <option value="droidcam">DroidCam (iPhone/Android)</option>
                    <option value="other">Other Mobile Camera</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="ip_address">IP Address *</label>
                    <input type="text" id="ip_address" name="ip_address" placeholder="e.g., 192.168.1.100">
                    <small>Find this in your mobile camera app</small>
                </div>
                
                <div class="form-group">
                    <label for="port">Port *</label>
                    <input type="number" id="port" name="port" value="8080">
                    <small id="port-hint">Default: 8080 for IP Webcam</small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="stream_path">Stream Path</label>
                <input type="text" id="stream_path" name="stream_path" value="/video">
                <small id="path-hint">Will be auto-detected if left as default</small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="username">Username (Optional)</label>
                    <input type="text" id="username" name="username" placeholder="Leave empty if no auth">
                </div>
                
                <div class="form-group">
                    <label for="password">Password (Optional)</label>
                    <input type="password" id="password" name="password" placeholder="Leave empty if no auth">
                </div>
            </div>
            
            <div class="info-box">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                <div>
                    <strong>Setup Instructions:</strong>
                    <ol>
                        <li>Install IP Webcam (Android) or DroidCam (iPhone) on your phone</li>
                        <li>Connect your phone to the same WiFi network as this server</li>
                        <li>Start the camera app and note the IP address and port</li>
                        <li>Copy the full URL from the app OR enter details manually</li>
                        <li>Stream path will be auto-detected if not specified</li>
                    </ol>
                </div>
            </div>
            
            <div class="form-actions">
                <a href="{% url 'mobile_cameras:dashboard' %}" class="btn-cancel">Cancel</a>
                <button type="submit" class="btn-submit">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Mobile Camera
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.form-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
}

.form-card-large {
    background: white;
    padding: 2.5rem;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.form-card-large h2 {
    font-size: 2rem;
    font-weight: 700;
    color: #212529;
    margin-bottom: 0.5rem;
}

.subtitle {
    color: #6c757d;
    margin-bottom: 2rem;
}

.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.alert-error {
    background: #f8d7da;
    border: 1px solid #f5c2c7;
    color: #842029;
}

.divider {
    text-align: center;
    margin: 1.5rem 0;
    position: relative;
}

.divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #dee2e6;
}

.divider span {
    background: white;
    padding: 0 1rem;
    position: relative;
    color: #6c757d;
    font-weight: 600;
}

.info-box {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    padding: 1.5rem;
    border-radius: 12px;
    margin: 1.5rem 0;
    display: flex;
    gap: 1rem;
    border-left: 4px solid #2196f3;
}

.info-box svg {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
    stroke: #2196f3;
    margin-top: 0.25rem;
}

.info-box ol {
    margin: 0.5rem 0 0 1.5rem;
}

.info-box li {
    margin-bottom: 0.5rem;
    color: #1976d2;
}

.btn-submit {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-submit svg {
    width: 20px;
    height: 20px;
}
</style>

<script>
function updateDefaults() {
    const cameraType = document.getElementById('camera_type').value;
    const portInput = document.getElementById('port');
    const pathInput = document.getElementById('stream_path');
    const portHint = document.getElementById('port-hint');
    const pathHint = document.getElementById('path-hint');
    
    if (cameraType === 'ip_webcam') {
        portInput.value = '8080';
        pathInput.value = '/video';
        portHint.textContent = 'Default: 8080 for IP Webcam';
        pathHint.textContent = 'Will be auto-detected if left as default';
    } else if (cameraType === 'droidcam') {
        portInput.value = '4747';
        pathInput.value = '/mjpegfeed';
        portHint.textContent = 'Default: 4747 for DroidCam';
        pathHint.textContent = 'Will be auto-detected if left as default';
    } else {
        portInput.value = '8080';
        pathInput.value = '/video';
        portHint.textContent = 'Common ports: 8080, 4747, 8000';
        pathHint.textContent = 'Will be auto-detected if left as default';
    }
}

// Auto-fill form when URL is pasted
document.getElementById('camera_url').addEventListener('input', function(e) {
    const url = e.target.value.trim();
    if (!url) return;
    
    try {
        const urlObj = new URL(url);
        
        // Extract IP and port
        if (urlObj.hostname) {
            document.getElementById('ip_address').value = urlObj.hostname;
        }
        if (urlObj.port) {
            document.getElementById('port').value = urlObj.port;
        }
        
        // Extract path
        if (urlObj.pathname) {
            document.getElementById('stream_path').value = urlObj.pathname;
        }
        
        // Extract username and password
        if (urlObj.username) {
            document.getElementById('username').value = urlObj.username;
        }
        if (urlObj.password) {
            document.getElementById('password').value = urlObj.password;
        }
        
        // Detect camera type from path
        const path = urlObj.pathname.toLowerCase();
        if (path.includes('mjpeg')) {
            document.getElementById('camera_type').value = 'droidcam';
        } else if (path.includes('video')) {
            document.getElementById('camera_type').value = 'ip_webcam';
        }
        
        // Auto-generate name if empty
        if (!document.getElementById('name').value) {
            document.getElementById('name').value = `Camera ${urlObj.hostname}`;
        }
    } catch (err) {
        // Invalid URL, ignore
    }
});
</script>
{% endblock %}
