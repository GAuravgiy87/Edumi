{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Manage Camera Permissions</h1>
        <p class="subtitle">{{ camera.name }}</p>
    </div>
    
    <div class="permissions-grid">
        <!-- Authorized Teachers -->
        <div class="permission-card">
            <div class="card-header">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    Authorized Teachers
                </h2>
                <span class="badge">{{ authorized_teachers.count }}</span>
            </div>
            
            <div class="teacher-list">
                {% if authorized_teachers %}
                    {% for teacher in authorized_teachers %}
                    <div class="teacher-item authorized">
                        <div class="teacher-info">
                            <img src="https://ui-avatars.com/api/?name={{ teacher.get_full_name|default:teacher.username|urlencode }}&background=10b981&color=fff&size=40" alt="{{ teacher.username }}">
                            <div>
                                <p class="teacher-name">{{ teacher.get_full_name|default:teacher.username }}</p>
                                <p class="teacher-username">@{{ teacher.username }}</p>
                            </div>
                        </div>
                        <button class="btn-revoke" onclick="revokePermission({{ camera.id }}, {{ teacher.id }}, '{{ teacher.username }}')">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            Revoke
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        <p>No teachers have access yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Unauthorized Teachers -->
        <div class="permission-card">
            <div class="card-header">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    Available Teachers
                </h2>
                <span class="badge">{{ unauthorized_teachers.count }}</span>
            </div>
            
            <div class="teacher-list">
                {% if unauthorized_teachers %}
                    {% for teacher in unauthorized_teachers %}
                    <div class="teacher-item">
                        <div class="teacher-info">
                            <img src="https://ui-avatars.com/api/?name={{ teacher.get_full_name|default:teacher.username|urlencode }}&background=6366f1&color=fff&size=40" alt="{{ teacher.username }}">
                            <div>
                                <p class="teacher-name">{{ teacher.get_full_name|default:teacher.username }}</p>
                                <p class="teacher-username">@{{ teacher.username }}</p>
                            </div>
                        </div>
                        <button class="btn-grant" onclick="grantPermission({{ camera.id }}, {{ teacher.id }}, '{{ teacher.username }}')">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Grant Access
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <p>All teachers have access</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="actions">
        <a href="{% url 'admin_dashboard' %}" class="btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            Back to Dashboard
        </a>
    </div>
</div>

<style>
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.page-header {
    margin-bottom: 2rem;
}

.page-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 0.5rem;
}

.subtitle {
    color: var(--gray-600);
    font-size: 1.1rem;
}

.permissions-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
    margin-bottom: 2rem;
}

.permission-card {
    background: var(--white);
    border-radius: 12px;
    border: 1px solid var(--gray-200);
    overflow: hidden;
}

.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
}

.card-header h2 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-900);
}

.card-header h2 svg {
    width: 24px;
    height: 24px;
    stroke: var(--primary);
}

.badge {
    background: var(--primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
}

.teacher-list {
    padding: 1rem;
    max-height: 500px;
    overflow-y: auto;
}

.teacher-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    background: var(--gray-50);
    transition: all 0.2s;
}

.teacher-item:hover {
    background: var(--white);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.teacher-item.authorized {
    border-left: 3px solid var(--success);
}

.teacher-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.teacher-info img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
}

.teacher-name {
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.25rem;
}

.teacher-username {
    color: var(--gray-500);
    font-size: 0.875rem;
}

.btn-grant, .btn-revoke {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-grant {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    color: white;
}

.btn-grant:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-revoke {
    background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
    color: white;
}

.btn-revoke:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.btn-grant svg, .btn-revoke svg {
    width: 16px;
    height: 16px;
}

.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--gray-500);
}

.empty-state svg {
    width: 48px;
    height: 48px;
    margin-bottom: 1rem;
    stroke: var(--gray-400);
}

.actions {
    display: flex;
    justify-content: center;
}

.btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--gray-100);
    color: var(--gray-700);
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
}

.btn-secondary:hover {
    background: var(--gray-200);
}

.btn-secondary svg {
    width: 20px;
    height: 20px;
}

@media (max-width: 1024px) {
    .permissions-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function grantPermission(cameraId, teacherId, teacherName) {
    if (!confirm(`Grant camera access to ${teacherName}?`)) return;
    
    fetch(`/cameras/grant-permission/${cameraId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `teacher_id=${teacherId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Failed to grant permission');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function revokePermission(cameraId, teacherId, teacherName) {
    if (!confirm(`Revoke camera access from ${teacherName}?`)) return;
    
    fetch(`/cameras/revoke-permission/${cameraId}/${teacherId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Failed to revoke permission');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}
</script>
{% endblock %}
