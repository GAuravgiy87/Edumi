{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>{% if is_admin %}All Meetings{% else %}My Meetings{% endif %}</h1>
        {% if not is_admin %}
        <a href="{% url 'create_meeting' %}" class="btn-add-camera">+ Schedule Meeting</a>
        {% endif %}
    </div>
    
    {% if meetings %}
    <div class="meetings-list">
        {% for meeting in meetings %}
        <div class="meeting-card status-{{ meeting.status }}">
            <div class="meeting-header-info">
                <h3>{{ meeting.title }}</h3>
                <span class="meeting-status status-{{ meeting.status }}">{{ meeting.get_status_display }}</span>
            </div>
            
            <p class="meeting-description">{{ meeting.description|default:"No description" }}</p>
            
            {% if is_admin %}
            <div class="meeting-teacher-info">
                <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></span>
                <span>Teacher: {{ meeting.teacher.username }}</span>
            </div>
            {% endif %}
            
            <div class="meeting-details-grid">
                <div class="detail-item-small">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></span>
                    <div>
                        <p class="label">Date & Time</p>
                        <p class="value">{{ meeting.scheduled_time|date:"M d, Y - h:i A" }}</p>
                    </div>
                </div>
                
                <div class="detail-item-small">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></span>
                    <div>
                        <p class="label">Duration</p>
                        <p class="value">{{ meeting.duration_minutes }} minutes</p>
                    </div>
                </div>
                
                <div class="detail-item-small">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg></span>
                    <div>
                        <p class="label">Meeting Code</p>
                        <p class="value code">{{ meeting.meeting_code }}</p>
                    </div>
                </div>
                
                <div class="detail-item-small">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></span>
                    <div>
                        <p class="label">Participants</p>
                        <p class="value">{{ meeting.participants.count }}</p>
                    </div>
                </div>
            </div>
            
            <div class="meeting-actions">
                {% if meeting.status == 'scheduled' or meeting.status == 'live' %}
                <a href="{% url 'join_meeting' meeting.meeting_code %}" class="btn-view">
                    {% if meeting.status == 'scheduled' %}Start Meeting{% else %}Join Meeting{% endif %}
                </a>
                {% endif %}
                
                {% if meeting.status == 'live' %}
                <button onclick="endMeeting({{ meeting.id }})" class="btn-delete">End Meeting</button>
                {% endif %}
                
                {% if is_admin %}
                    {% if meeting.status == 'scheduled' %}
                    <button onclick="cancelMeeting({{ meeting.id }})" class="btn-cancel">Cancel</button>
                    {% endif %}
                    <button onclick="deleteMeeting({{ meeting.id }})" class="btn-delete">Delete</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-cameras">
        <p><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></span> No meetings {% if is_admin %}in the system{% else %}scheduled yet{% endif %}</p>
        {% if not is_admin %}
        <p style="margin-top: 1rem;"><a href="{% url 'create_meeting' %}" style="color: #1877f2; font-weight: 600;">Schedule your first meeting</a></p>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function endMeeting(meetingId) {
    if (confirm('Are you sure you want to end this meeting?')) {
        fetch(`/meetings/end/${meetingId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert(data.message || 'Failed to end meeting');
            }
        });
    }
}

function cancelMeeting(meetingId) {
    if (confirm('Are you sure you want to cancel this meeting?')) {
        fetch(`/meetings/cancel/${meetingId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert(data.message || 'Failed to cancel meeting');
            }
        });
    }
}

function deleteMeeting(meetingId) {
    if (confirm('Are you sure you want to permanently delete this meeting?')) {
        fetch(`/meetings/delete/${meetingId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert(data.message || 'Failed to delete meeting');
            }
        });
    }
}
</script>
{% endblock %}
